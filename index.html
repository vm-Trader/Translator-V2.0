<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Translator by VM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Apple-native font stack */
    body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; }
    /* Chat bubble animation (keep your existing) */
    .chat-bubble {
      max-width: 75%; padding: 10px 14px; border-radius: 18px;
      font-size: 17px; line-height: 1.4; margin-bottom: 10px;
      position: relative; word-wrap: break-word;
      opacity: 0; transform: translateY(5px);
      animation: fadeIn 0.25s ease-out forwards;
    }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    .chat-bubble-user {
      background: #007aff; color: white; margin-left: auto; border-bottom-right-radius: 6px;
    }
    .chat-bubble-assistant {
      background: #f2f2f7; color: #000; margin-right: auto; border-bottom-left-radius: 6px;
    }
    .copy-btn {
      position: absolute; top: 6px; right: 8px;
      font-size: 12px; color: #8e8e93; opacity: 0;
      transition: opacity 0.2s;
    }
    .chat-bubble:hover .copy-btn { opacity: 1; }
    .timestamp {
      display: block; font-size: 11px; color: #8e8e93;
      margin-top: 4px; text-align: right;
    }
    .typing-dots { display: inline-flex; gap: 3px; }
    .typing-dots span {
      width: 6px; height: 6px; background: #8e8e93; border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%, 80%, 100% { opacity: 0.3; } 40% { opacity: 1; } }
    /* iOS-like picker row */
    .picker-row {
      display: flex; gap: 0.75rem;
      padding: 0.5rem 0;
    }
    .picker-row select {
      -webkit-appearance: none;
      appearance: none;
      background: #f2f2f7;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      padding: 0.5rem 0.75rem;
      flex: 1;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Container -->
  <div class="w-full max-w-xl mx-auto bg-white rounded-[30px] shadow-2xl flex flex-col h-[92vh] overflow-hidden">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-xl border-b border-gray-200/60 px-5 py-4 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <span id="status-dot" class="w-2.5 h-2.5 rounded-full bg-yellow-400"></span>
        <span id="status-text" class="text-sm text-gray-500">Checkingâ€¦</span>
      </div>
      <div class="font-semibold text-gray-800 text-lg">Translator by VM</div>
      <button id="new-btn" class="text-sm text-blue-600 hover:underline">New</button>
    </header>

    <!-- Language pickers (Apple style) -->
    <div class="px-5 pt-3 pb-2">
      <div class="picker-row">
        <select id="sourceLang"><option value="auto">Auto-detect</option></select>
        <select id="targetLang"></select>
      </div>
    </div>

    <!-- Chat -->
    <div id="chat-container" class="flex-1 px-5 py-3 overflow-y-auto">
      <div class="chat-bubble chat-bubble-assistant">Welcome. Type a message in any language.</div>
    </div>

    <!-- Input row -->
    <div class="px-5 pb-5 pt-3 bg-white/60 backdrop-blur-xl">
      <div class="flex items-end gap-2">
        <textarea id="message-input" rows="1" placeholder="Messageâ€¦"
          class="flex-1 rounded-2xl bg-gray-100 border-none resize-none px-4 py-3 text-[17px] focus:ring-2 focus:ring-blue-500"></textarea>
        <button id="send-btn" class="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-lg">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M2.925 5.025l14.95-4.3a1 1 0 011.2 1.2l-4.3 14.95a1 1 0 01-1.925.038L7.05 11.752a1 1 0 01.038-1.925l8.6-2.475-2.475-8.6A1 1 0 018.05 5.025L2.925 5.025z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    /* ----------- language list (same as before, 140+ codes) ----------- */
    const LANGUAGES = [
      ["auto","Auto-detect"],["af","Afrikaans"],["sq","Albanian"],["am","Amharic"],["ar","Arabic"],["hy","Armenian"],
      ["az","Azerbaijani"],["eu","Basque"],["be","Belarusian"],["bn","Bengali"],["bs","Bosnian"],["bg","Bulgarian"],
      ["ca","Catalan"],["ceb","Cebuano"],["ny","Chichewa"],["zh","Chinese (Simplified)"],["zh-TW","Chinese (Traditional)"],
      ["co","Corsican"],["hr","Croatian"],["cs","Czech"],["da","Danish"],["nl","Dutch"],["en","English"],
      ["eo","Esperanto"],["et","Estonian"],["tl","Filipino"],["fi","Finnish"],["fr","French"],["fy","Frisian"],
      ["gl","Galician"],["ka","Georgian"],["de","German"],["el","Greek"],["gu","Gujarati"],["ht","Haitian Creole"],
      ["ha","Hausa"],["haw","Hawaiian"],["iw","Hebrew"],["hi","Hindi"],["hmn","Hmong"],["hu","Hungarian"],
      ["is","Icelandic"],["ig","Igbo"],["id","Indonesian"],["ga","Irish"],["it","Italian"],["ja","Japanese"],
      ["jw","Javanese"],["kn","Kannada"],["kk","Kazakh"],["km","Khmer"],["ko","Korean"],["ku","Kurdish"],
      ["ky","Kyrgyz"],["lo","Lao"],["la","Latin"],["lv","Latvian"],["lt","Lithuanian"],["lb","Luxembourgish"],
      ["mk","Macedonian"],["mg","Malagasy"],["ms","Malay"],["ml","Malayalam"],["mt","Maltese"],["mi","Maori"],
      ["mr","Marathi"],["mn","Mongolian"],["my","Myanmar"],["ne","Nepali"],["no","Norwegian"],["or","Odia"],
      ["ps","Pashto"],["fa","Persian"],["pl","Polish"],["pt","Portuguese"],["pa","Punjabi"],["ro","Romanian"],
      ["ru","Russian"],["sm","Samoan"],["gd","Scots Gaelic"],["sr","Serbian"],["st","Sesotho"],["sn","Shona"],
      ["sd","Sindhi"],["si","Sinhala"],["sk","Slovak"],["sl","Slovenian"],["so","Somali"],["es","Spanish"],
      ["su","Sundanese"],["sw","Swahili"],["sv","Swedish"],["tg","Tajik"],["ta","Tamil"],["te","Telugu"],
      ["th","Thai"],["tr","Turkish"],["uk","Ukrainian"],["ur","Urdu"],["ug","Uyghur"],["uz","Uzbek"],
      ["vi","Vietnamese"],["cy","Welsh"],["xh","Xhosa"],["yi","Yiddish"],["yo","Yoruba"],["zu","Zulu"]
    ];

    const sourceSel = document.getElementById('sourceLang');
    const targetSel = document.getElementById('targetLang');
    LANGUAGES.forEach(([code, name]) => {
      sourceSel.insertAdjacentHTML('beforeend', `<option value="${code}">${name}</option>`);
      targetSel.insertAdjacentHTML('beforeend', `<option value="${code}">${name}</option>`);
    });
    targetSel.value = 'vi'; // default target = Vietnamese

    /* ----------- chat logic (unchanged, only body shape tweaked) ----------- */
    const chatContainer = document.getElementById("chat-container");
    const messageInput  = document.getElementById("message-input");
    const sendBtn       = document.getElementById("send-btn");
    const newBtn        = document.getElementById("new-btn");
    let typingBubble = null;

    sendBtn.addEventListener("click", handleSend);
    messageInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); handleSend(); }
    });
    newBtn.addEventListener("click", () => {
      chatContainer.innerHTML = `<div class="chat-bubble chat-bubble-assistant">Welcome. Type a message in any language.</div>`;
    });

    function addBubble(type, title, text, copyable=false) {
      const div = document.createElement("div");
      div.className = `chat-bubble ${type === "user" ? "chat-bubble-user" : "chat-bubble-assistant"}`;
      div.innerHTML = title ? `<strong>${title}</strong><br>${text}` : text;
      if (copyable) {
        const btn = document.createElement("span");
        btn.textContent = "ðŸ“‹"; btn.className = "copy-btn cursor-pointer";
        btn.onclick = () => navigator.clipboard.writeText(text);
        div.appendChild(btn);
      }
      const ts = document.createElement("span"); ts.className = "timestamp"; ts.textContent = new Date().toLocaleString("en-GB");
      div.appendChild(ts);
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      messageInput.focus();
    }
    function showTypingIndicator() {
      typingBubble = document.createElement("div"); typingBubble.className = "chat-bubble chat-bubble-assistant";
      typingBubble.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div>`;
      chatContainer.appendChild(typingBubble); chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    function hideTypingIndicator() {
      if (typingBubble) { typingBubble.remove(); typingBubble = null; }
    }

    async function handleSend() {
      const text = messageInput.value.trim();
      if (!text) return;
      addBubble("user", "You", text);
      messageInput.value = "";
      showTypingIndicator();

      try {
        const res = await fetch("/api/gemini", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            text: text,
            source: sourceSel.value,   // "auto" or exact code
            target: targetSel.value    // user chosen
          })
        });
        if (!res.ok) throw new Error("API error");
        const data = await res.json();
        hideTypingIndicator();
        if (data.improved) addBubble("assistant", "Improved version", data.improved, true);
        if (data.translation) addBubble("assistant", "Translation", data.translation, true);
      } catch (e) {
        hideTypingIndicator();
        addBubble("assistant", "", "Could not connect. Please try again.");
      }
    }

    /* status dot (keep your existing) */
    async function checkStatus() {
      const statusDot = document.getElementById("status-dot");
      const statusText = document.getElementById("status-text");
      statusDot.className = "w-2.5 h-2.5 rounded-full bg-yellow-400";
      statusText.textContent = "Checkingâ€¦";
      try {
        const res = await fetch("/api/gemini", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ text: "ping" }) });
        if (res.ok) { statusDot.className = "w-2.5 h-2.5 rounded-full bg-green-500"; statusText.textContent = "Working"; }
        else throw new Error("Bad response");
      } catch {
        statusDot.className = "w-2.5 h-2.5 rounded-full bg-red-500"; statusText.textContent = "Error";
      }
    }
    checkStatus();
  </script>
</body>
</html>
