<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Translator by VM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; }
    .chat-bubble {
      max-width: 75%; padding: 10px 14px; border-radius: 18px;
      font-size: 15px; line-height: 1.4; margin-bottom: 10px;
      position: relative; word-wrap: break-word;
      opacity: 0; transform: translateY(5px);
      animation: fadeIn 0.25s ease-out forwards;
    }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    .chat-bubble-user {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white; margin-left: auto; border-bottom-right-radius: 6px;
    }
    .chat-bubble-assistant {
      background: #f3f4f6; color: #111; margin-right: auto; border-bottom-left-radius: 6px;
    }
    .copy-btn {
      position: absolute; top: 6px; right: 8px;
      font-size: 12px; color: #6b7280; opacity: 0;
      transition: opacity 0.2s;
    }
    .chat-bubble:hover .copy-btn { opacity: 1; }
    .timestamp {
      display: block; font-size: 11px; color: #9ca3af;
      margin-top: 4px; text-align: right;
    }
    .typing-dots { display: inline-flex; gap: 3px; }
    .typing-dots span {
      width: 6px; height: 6px; background: #6b7280; border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%, 80%, 100% { opacity: 0.3; } 40% { opacity: 1; } }
  </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen">

<div class="w-full max-w-xl mx-auto bg-white rounded-2xl shadow-2xl flex flex-col h-[90vh] overflow-hidden">

  <!-- Header -->
  <header class="bg-white border-b border-slate-200 p-3 flex justify-between items-center">
    <div class="flex items-center gap-2">
      <span id="status-dot" class="w-3 h-3 rounded-full bg-green-500"></span>
      <span id="status-text" class="text-sm text-slate-500">Working</span>
    </div>
    <div class="font-semibold text-slate-800">Translator by VM</div>
    <button id="new-btn" class="text-sm text-blue-600 hover:underline">New</button>
  </header>

  <!-- Chat -->
  <div id="chat-container" class="flex-1 p-4 bg-slate-50 overflow-y-auto">
    <div class="chat-bubble chat-bubble-assistant">Welcome. Type a message in English or Vietnamese.</div>
  </div>

  <!-- Input -->
  <div class="flex items-center p-3 bg-white border-t">
    <textarea id="message-input" rows="1" placeholder="Message..." 
      class="flex-1 p-2 rounded-full border border-slate-300 focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
    <button id="send-btn" class="ml-2 bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center">âž¤</button>
  </div>
</div>

<script>
  const chatContainer = document.getElementById("chat-container");
  const messageInput = document.getElementById("message-input");
  const sendBtn = document.getElementById("send-btn");
  const newBtn = document.getElementById("new-btn");
  let typingBubble = null;

  sendBtn.addEventListener("click", handleSend);
  messageInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  newBtn.addEventListener("click", () => {
    chatContainer.innerHTML = `<div class="chat-bubble chat-bubble-assistant">Welcome. Type a message in English or Vietnamese.</div>`;
  });

  function addBubble(type, title, text, copyable=false) {
    const div = document.createElement("div");
    div.className = `chat-bubble ${type === "user" ? "chat-bubble-user" : "chat-bubble-assistant"}`;
    div.innerHTML = title ? `<strong>${title}</strong><br>${text}` : text;
    if (copyable) {
      const btn = document.createElement("span");
      btn.textContent = "ðŸ“‹";
      btn.className = "copy-btn cursor-pointer";
      btn.onclick = () => navigator.clipboard.writeText(text);
      div.appendChild(btn);
    }
    const ts = document.createElement("span");
    ts.className = "timestamp";
    ts.textContent = new Date().toLocaleString("en-GB");
    div.appendChild(ts);

    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    messageInput.focus();
  }

  function showTypingIndicator() {
    typingBubble = document.createElement("div");
    typingBubble.className = "chat-bubble chat-bubble-assistant";
    typingBubble.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div>`;
    chatContainer.appendChild(typingBubble);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function hideTypingIndicator() {
    if (typingBubble) {
      typingBubble.remove();
      typingBubble = null;
    }
  }

  async function handleSend() {
    const text = messageInput.value.trim();
    if (!text) return;
    addBubble("user", "You", text);

    messageInput.value = "";
    showTypingIndicator();

    try {
      const res = await fetch("/api/gemini", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
      });
      if (!res.ok) throw new Error("API error");
      const data = await res.json();
      hideTypingIndicator();

      if (data.improved) addBubble("assistant", "Improved version", data.improved, true);
      if (data.translation) addBubble("assistant", "Translation", data.translation, true);

    } catch (err) {
      hideTypingIndicator();
      addBubble("assistant", "", "Could not connect. Please try again.");
    }
  }
</script>
</body>
</html>
